<style>
tr.in-preview td { background: #ffb }
div.ticket-list-with-previewinsearch table.ticket-list { table-layout:fixed; }
</style>
<script type="text/javascript">
var ticket_list = jQuery('div#body');

% if ( RT->Config->Get('SideBySidePreview') ) {
ticket_list.wrap( "<div class='row m-3'><div class='ticket-list-with-previewinsearch col-6'></div></div>" );
jQuery('div.ticket-list-with-previewinsearch').after( "<div id='ticket-preview-container' class='col-6'><p>foobar</p></div>" );
% } else {
ticket_list.after( "<div class='row m-3'><div id='ticket-preview-container' class='col-12'><p>foobar</p></div></div>" );
% }

var get_ticket_row = function (from) {
    var row = jQuery(from).closest('tr');
    var even_or_odd = row.hasClass('oddline')? 'evenline': 'oddline';
    row = row.add(
        row.prevUntil( '.' + even_or_odd, '[class*="line"]' )
    ).add(
        row.nextUntil( '.' + even_or_odd, '[class*="line"]' )
    );
    return row;
};

var do_preview = function (row) {
    var tid = row.find('> td a[href*="Display.html?id="]').first().attr('href').match(/Display\.html\?id=(\d+)/)[1];
    var url = <% RT->Config->Get('WebPath') |n,j %> +'/Helpers/TicketPreview?id='+tid;
    row.closest('table').children('tbody').children('tr').removeClass('in-preview');
    row.addClass('in-preview');
    jQuery('#ticket-preview-container').text(<% loc('Loading...') |n,j %>).load( url );
};

jQuery(document).ready(function() {
    do_preview( get_ticket_row( jQuery('table.ticket-list tbody tr td').first() ) );

    // if RT 5.0.4 or newer need to adjust calculation of max-height of search filter modal
    if ( jQuery(".search-filter") ) {
        jQuery(".search-filter").click(function(ev){
            ev.preventDefault();
            var modal = jQuery(this).closest('th').find('.modal.search-results-filter');
            modal.css('top', jQuery(this).offset().top);
            var left = jQuery(this).offset().left;
            // 10 is extra space to move modal a bit away from edge
            if ( left + modal.width() + 10 > jQuery('body').width() ) {
                left = jQuery('body').width() - modal.width() - 10;
            }
            modal.css('left', left);
            modal.find('div.modal-content').css('max-height', jQuery(window).height() - jQuery(this).offset().top - 160 );
            modal.modal('show');
        });
    }
});

jQuery(function(){
    jQuery('table.collection-as-table > tbody > tr > td').on('click', function (e) {
        if (e.target.tagName != 'TD')
            return;

        var row = get_ticket_row(e.target);
        do_preview(row);
    });
});
</script>
<%ARGS>
</%ARGS>
<%INIT>
my $web_style = $session{'CurrentUser'}
    ? $session{'CurrentUser'}->Stylesheet
    : RT->Config->Get('WebDefaultStylesheet');
</%INIT>
